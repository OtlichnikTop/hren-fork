#!/bin/bash
xset s on
xset +dpms

while :; do
	focused=true
	fullscreen=false
	active_window=$(xdotool getactivewindow)
	echo "$active_window is active"
	
	#Monitor active window
	xprop -id $active_window -spy _NET_WM_STATE |
		while read line; do
			[[ "$line" != *"_NET_WM_STATE_FOCUSED"* ]] && focused=false #Lost focus
			
			if $focused && [[ "$line" == *"_NET_WM_STATE_FULLSCREEN"* ]]; then
				if ! $fullscreen; then
					#Window state changed to fullscreen
					echo "Screensaver disabled"
					fullscreen=true
					xset s off
					xset -dpms
				fi
			elif $fullscreen; then
				#State changed, active is no longer fullscreen
				echo "Screensaver enabled"
				fullscreen=false
				xset s on
				xset +dpms
			fi
			
			#Window lost focus, get new active
			! $focused && kill $!
		done &
	wait $!
done
